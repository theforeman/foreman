name: (non-blocking) React on plugins

on:
  pull_request:
    branches: [develop]
    paths:
      - 'webpack/**'
      - 'package.json'
      - 'config/webpack.config.js'
      - '.github/workflows/plugins_react_tests.yml'

permissions:
  contents: read

concurrency:
  group: ${{ github.ref_name }}-${{ github.workflow }}
  cancel-in-progress: true

env:
  BUNDLE_WITHOUT: "console:development:journald:libvirt"

jobs:
  setup_matrix:
    name: Setup matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build_matrix.outputs.matrix }}
    steps:
      - name: Build test matrix
        id: build_matrix
        uses: theforeman/gha-matrix-builder@v0

  test:
    name: ${{ matrix.plugin }} with Ruby ${{ matrix.ruby }} and Node ${{ matrix.node }}
    runs-on: ubuntu-latest
    needs: setup_matrix
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        ruby: ${{ fromJson(needs.setup_matrix.outputs.matrix).ruby }}
        node: ${{ fromJson(needs.setup_matrix.outputs.matrix).node }}
        plugin:
          - theforeman/foreman-tasks
          - Katello/katello
    steps:
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
      - name: "Set up Ruby ${{ matrix.ruby }}"
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: true
      - name: Checkout Foreman
        uses: actions/checkout@v4
        with:
          path: ${{ github.workspace }}/projects/foreman
      - name: Generate Foreman npm dependencies package-lock
        run: npm install --package-lock-only --no-audit
        working-directory: ${{ github.workspace }}/projects/foreman
      - name: Install Foreman npm dependencies
        run: npm ci --no-audit
        working-directory: ${{ github.workspace }}/projects/foreman
      - name: Checkout ${{ matrix.plugin }}
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.plugin }}
          path: ${{ github.workspace }}/projects/plugin
      - name: store plugin name
        run: echo "PLUGIN_NAME=$(echo ${{ matrix.plugin }} | awk -F'/' '{print $NF}')" >> "${GITHUB_ENV}"
      - name: Set up plugin in Foreman
        run: |
          echo "gemspec name: '$PLUGIN_NAME', path: '${{ github.workspace }}/projects/plugin'" > "bundler.d/$PLUGIN_NAME.local.rb"
          if [ -d $PLUGIN_NAME/gemfile.d ] ; then
            cat $PLUGIN_NAME/gemfile.d/*.rb >> bundler.d/$PLUGIN_NAME.local.rb
          fi
        working-directory: ${{ github.workspace }}/projects/foreman
      - name: Generate ${{ matrix.plugin }} npm dependencies package-lock
        run: npm install --package-lock-only --no-audit --legacy-peer-deps
        working-directory: ${{ github.workspace }}/projects/plugin
      - name: Install ${{ matrix.plugin }} npm dependencies
        run: npm ci --no-audit --legacy-peer-deps
        working-directory: ${{ github.workspace }}/projects/plugin
      - run: sudo apt-get update
      - run: sudo apt-get -qq -y install build-essential libcurl4-openssl-dev zlib1g-dev libpq-dev libvirt-dev
      - name: Install gems
        run: bundle install 
        working-directory: ${{ github.workspace }}/projects/foreman
      - name: Run plugin webpack dir to test
        run: ./script/plugin_webpack_directories.rb   
        working-directory: ${{ github.workspace }}/projects/foreman
      - name: Run ${{ matrix.plugin }} tests
        run: npm run test:plugins $(echo ${{ matrix.plugin }} | awk -F'/' '{print $NF}')
        working-directory: ${{ github.workspace }}/projects/foreman
