<%#
kind: registration
name: Linux registration default
model: ProvisioningTemplate
oses:
- CentOS
- Fedora
- Debian
- Ubuntu
-%>
#!/bin/bash

set -e

# This script enrolls a host with Foreman.
# Host: <%= @host.name %>

<% if @host.puppetmaster.present? -%>
<%= snippet 'puppetlabs_repo' %>
<%= snippet 'puppet_setup' %>
<% end -%>

<%= snippet 'remote_execution_ssh_keys' %>

<% if host_param_true?('host_registration_insights') -%>
if [ -f /etc/os-release ] ; then
  . /etc/os-release
fi

if [ x$ID = xrhel ]; then
  echo '#'
  echo '# Installing Insights client'
  echo '#'

  yum install -y insights-client
  insights-client --register
fi
<% end -%>

# Call home to exit build mode

curl -o /dev/null --noproxy \* '<%= foreman_url('built') %>'

echo "Successfully enrolled host <%= @host.name %> with Foreman."

exit 0
