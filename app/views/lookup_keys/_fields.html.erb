
<div <%= "id=#{(f.object.key || 'new_lookup_keys').to_s.gsub(' ','_')} class='tab-pane fields' " %> >

  <% if f.object.is_param -%>
    <div class='control-group'>
      <h6>Used by the <%= f.object.environment_classes.map(&:environment).to_sentence %> environments</h6>
    </div>
  <% end -%>

  <%= remove_child_link "Remove #{f.object.new_record? ? "Variable" : f.object}", f , {:class => 'btn btn-danger hide'} unless controller_name == "lookup_keys" %>
  <%= text_f f, :key, :label => "Name", :disabled => f.object.is_param %>
  <%= f.hidden_field :key if f.object.is_param %>
  <%= textarea_f f, :description, :rows => :auto, :class=> "span6" %>

  <%= # In case of a new smart-var inside a puppetclass (REST nesting only), or a class parameter:
      # Show the parent puppetclass as a context, but permit no change.
    if params["puppetclass_id"]
      select_f f, :puppetclass_id, [Puppetclass.find(params["puppetclass_id"])], :id, :to_label, {}, {:label => "Puppet class", :disabled => true}
    elsif f.object.is_param && f.object.param_class
      field(f, :puppetclass_id, :label => 'Puppet Class') do
        content_tag(:input, nil, :value => f.object.param_class, :type => 'text', :disabled => true)
      end
    else # new smart-var with no particular context
      # Give a select for choosing the parent puppetclass
      select_f(f, :puppetclass_id, Puppetclass.all, :id, :to_label, { :include_blank => 'None' }, {:label => "Puppet class"})
    end unless @puppetclass # nested smart-vars form in a tab of puppetclass/_form: no edition allowed, and the puppetclass is already visible as a context
  %>
  <% if f.object.is_param%>
      <%= checkbox_f(f, :override, :label => "Override", :onchange=>'toggleOverrideValue(this)', :disabled => f.object.required,
                      :help_inline => popover("?", "Whether the smart-variable should override the Puppet class default value.", :title => "Override Value")) %>
      <%= checkbox_f f, :required, :onchange=>'toggleMandatory(this)', :disabled => !f.object.override,
                 :help_inline => popover("?", "If checked, will raise an error if there is no default value and no matcher provide a value.", :title => "Required Parameter") %>
  <%- end %>
  <%= textarea_f f, :default_value, :value => f.object.default_value_before_type_cast , :disabled => (f.object.is_param && !f.object.override), :class => "span6", :rows => :auto, :help_inline => popover("?","value to use when there is no match", :title => "Default Value") %>
  <div <%= "id=#{(f.object.key || 'new_lookup_keys').to_s.gsub(' ','_')}_lookup_key_override_value" %> <%= "style='display:none;'" if (f.object.is_param && !f.object.override) %>>
  <%= selectable_f f, :validator_type, options_for_select(LookupKey::VALIDATION_TYPES, f.object.validator_type),
                     {},
                     { :label => "Type", :class => "medium", :help_inline => popover("?","<dl>
           <dt>String</dt> <dd>Everything is taken as a string.</dd>
           <dt>Boolean</dt> <dd>Common representation of boolean values are accepted.</dd>
           <dt>Integer</dt> <dd>Integer numbers only, can be negative.</dd>
           <dt>Real</dt> <dd>Accept any numerical input.</dd>
           <dt>Array</dt> <dd>A valid JSON or YAML input, that must evaluate to an array.</dd>
           <dt>Hash</dt> <dd>A valid JSON or YAML input, that must evaluate to an object/map/dict/hash.</dd>
           <dt>YAML</dt> <dd>Any valid YAML input.</dd>
           <dt>JSON</dt> <dd>Any valid JSON input.</dd>
           </dl>", :title => "How values are validated").html_safe}
  %>
  <%= textarea_f f, :path, :rows => "4", :label => "Order",
    :help_inline => popover("?", "The order in which matchers keys are processed, first match wins.<br>
    You may use multiple attributes as a matcher key, for example, an order of <code>hostgroup, environment</code>
    would expect a matcher such as <code>hostgroup = \"web servers\", environment = production</code>", :title => "The order in which values are resolved").html_safe
  %>

  <%# the following field is required to see child validations %>
  <%= f.hidden_field :updated_at, :value => Time.now.to_i %>
  <div class="children_fields">
    <%= new_child_fields_template(f, :lookup_values, {:partial => "lookup_keys/value"}) %>
    <%= f.fields_for :lookup_values do |lookup_values| %>
      <%= render 'lookup_keys/value', :f => lookup_values %>
    <% end %>
    <%= add_child_link "+ Add Matcher-Value", :lookup_values, { :title => 'add a new matcher-value pair'} %>
  </div>
</div>
</div>
